<html>
<head>
    <script language="JavaScript">
        const signalChannel = new WebSocket("ws://localhost:8080/signal");

        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        }
        const connection = new RTCPeerConnection(config);

        connection.addEventListener("icecandidate", (event) =>
            console.log("ICE: >> " + event));

        connection.addEventListener("datachannel", (event) => {
            const channel = event.channel;
            channel.addEventListener("message", (event) => console.log(event));
        });


        signalChannel.addEventListener("open", async (event) => {
            signalChannel.send(JSON.stringify({
                type: "follower"
            }));
        });

        signalChannel.addEventListener("message", async (event) => {
            console.log(" >> " + event.data);
            let data = JSON.parse(event.data);
            if (data.type === "offer") {
                await createAnswer(data);
            }
            if (data.type === "ice_candidate") {
                await setIceCandidate(JSON.parse(data.sdp));
            }
        });

        async function createAnswer(offer) {
            console.log("setting offer " + JSON.stringify(offer));
            await connection.setRemoteDescription(offer);
            console.log("remote description is " + connection.remoteDescription);
            const answer = await connection.createAnswer();
            await connection.setLocalDescription(answer);
            await signalChannel.send(JSON.stringify(answer));
            console.log("answer sent");
            console.log("remote description is " + connection.remoteDescription);
        }

        async function setIceCandidate(candidate) {
            await connection.addIceCandidate(candidate);
        }
    </script>
</head>
<body>
<textarea readonly="readonly"></textarea>
<input type="text"></input>
</body>
</html>
